<tool id="flexynesis_plot" name="Flexynesis plot" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>tool for visualizing flexynesis results</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <required_files>
        <include path="flexynesis_plot.py" />
    </required_files>
    <command detect_errors="exit_code"><![CDATA[
        @CHECK_NON_COMMERCIAL_USE@
        mkdir -p inputs/ plots/ &&
        ln -s '$plot_conditional.labels' 'inputs/$plot_conditional.labels.element_identifier.$plot_conditional.labels.ext' &&
        #if $plot_conditional.plot_type == "dimred":
            ln -s '$plot_conditional.embeddings' 'inputs/$plot_conditional.embeddings.element_identifier.$plot_conditional.embeddings.ext' &&
        #end if
        #if $plot_conditional.plot_type == "dimred":
            ## set target variables
            color=`$__tool_directory__/index_to_name.py 'inputs/$plot_conditional.labels.element_identifier.$plot_conditional.labels.ext' $plot_conditional.color` &&
            echo "Color: \$color" &&
            python '$__tool_directory__/flexynesis_plot.py'
                --plot_type dimred
                --embeddings 'inputs/$plot_conditional.embeddings.element_identifier.$plot_conditional.embeddings.ext'
                --labels 'inputs/$plot_conditional.labels.element_identifier.$plot_conditional.labels.ext'
                --method $plot_conditional.method
                --color \$color
                --output_dir plots
                --format $plot_conditional.format
                --dpi $plot_conditional.dpi

        #else if $plot_conditional.plot_type == "scatter":
            python '$__tool_directory__/flexynesis_plot.py'
                --plot_type scatter
                --labels 'inputs/$plot_conditional.labels.element_identifier.$plot_conditional.labels.ext'
                --output_dir plots
                --format $plot_conditional.format
                --dpi $plot_conditional.dpi
        #else if $plot_conditional.plot_type == "concordance_heatmap":
            python '$__tool_directory__/flexynesis_plot.py'
                --plot_type concordance_heatmap
                --labels 'inputs/$plot_conditional.labels.element_identifier.$plot_conditional.labels.ext'
                --output_dir plots
                --format $plot_conditional.format
                --dpi $plot_conditional.dpi
        #else if $plot_conditional.plot_type == "pr_curve":
            python '$__tool_directory__/flexynesis_plot.py'
                --plot_type pr_curve
                --labels 'inputs/$plot_conditional.labels.element_identifier.$plot_conditional.labels.ext'
                --output_dir plots
                --format $plot_conditional.format
                --dpi $plot_conditional.dpi
        #else if $plot_conditional.plot_type == "roc_curve":
            python '$__tool_directory__/flexynesis_plot.py'
                --plot_type roc_curve
                --labels 'inputs/$plot_conditional.labels.element_identifier.$plot_conditional.labels.ext'
                --output_dir plots
                --format $plot_conditional.format
                --dpi $plot_conditional.dpi
        #else if $plot_conditional.plot_type == "box_plot":
            python '$__tool_directory__/flexynesis_plot.py'
                --plot_type box_plot
                --labels 'inputs/$plot_conditional.labels.element_identifier.$plot_conditional.labels.ext'
                --output_dir plots
                --format $plot_conditional.format
                --dpi $plot_conditional.dpi
        #end if
    ]]></command>
    <inputs>
        <expand macro="commercial_use_param"/>
        <conditional name="plot_conditional">
            <param name="plot_type" type="select" label="Flexynesis plot">
                <option value="dimred">Dimensionality reduction</option>
                <option value="scatter">Scatter plot of known vs predicted labels</option>
                <option value="concordance_heatmap">Label concordance heatmap</option>
                <option value="pr_curve">Precision-recall curves</option>
                <option value="roc_curve">ROC curves</option>
                <option value="box_plot">Box plot</option>
            </param>
            <when value="dimred">
                <expand macro="plots_common_param_svg">
                    <expand macro="plots_common_input"/>
                    <param argument="--embeddings" type="data" format="tabular" label="Embeddings" help="Generated by flexynesis"/>
                    <param argument="--color" type="data_column" data_ref="labels" label="Column in the labels file to use for coloring the points in the plot"/>
                    <param name="method" type="select" label="Transformation method">
                        <option value="pca" selected="true">PCA</option>
                        <option value="umap">UMAP</option>
                    </param>
                </expand>
            </when>
            <when value="scatter">
                <expand macro="plots_common_param_svg">
                    <expand macro="plots_common_input"/>
                </expand>
            </when>
            <when value="concordance_heatmap">
                <expand macro="plots_common_param_svg">
                    <expand macro="plots_common_input"/>
                </expand>
            </when>
            <when value="pr_curve">
                <expand macro="plots_common_param_svg">
                    <expand macro="plots_common_input"/>
                </expand>
            </when>
            <when value="roc_curve">
                <expand macro="plots_common_param_svg">
                    <expand macro="plots_common_input"/>
                </expand>
            </when>
            <when value="box_plot">
                <expand macro="plots_common_param_svg">
                    <expand macro="plots_common_input"/>
                </expand>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <collection name="plot_out" type="list" label="${tool.name} on ${on_string}: ${plot_conditional.plot_type} - ${plot_conditional.format}">
            <discover_datasets pattern="__name_and_ext__" directory="plots/"/>
            <filter>plot_conditional['format'] != 'svg'</filter>
        </collection>
        <!-- other types can be sniffed correctly by galaxy -->
        <collection name="plot_out_svg" format="svg" type="list" label="${tool.name} on ${on_string}: ${plot_conditional.plot_type} - svg">
            <discover_datasets pattern="__name_and_ext__" directory="plots/"/>
            <filter>plot_conditional['format'] == 'svg'</filter>
        </collection>
    </outputs>
    <tests>
        <!-- test 1: dimred -->
        <test expect_num_outputs="1">
            <param name="non_commercial_use" value="True"/>
            <conditional name="plot_conditional">
                <param name="plot_type" value="dimred"/>
                <param name="embeddings" value="embeddings.tabular"/>
                <param name="color" value="6"/>
                <param name="method" value="pca"/>
                <param name="labels" value="labels.tabular"/>
                <param name="format" value="jpg"/>
                <param name="dpi" value="300"/>
            </conditional>
            <output_collection name="plot_out" type="list" count="1">
                <element name="embeddings.tabular_pca_predicted_label">
                    <assert_contents>
                        <has_image_center_of_mass center_of_mass="970,731" eps="20"/>
                        <has_image_channels channels="3"/>
                        <has_image_height height="1460" delta="20"/>
                        <has_image_width width="1940" delta="20"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <!-- test 2: scatter -->
        <test expect_num_outputs="1">
            <param name="non_commercial_use" value="True"/>
            <conditional name="plot_conditional">
                <param name="plot_type" value="scatter"/>
                <param name="labels" value="labels_scatter.tabular"/>
                <param name="format" value="jpg"/>
                <param name="dpi" value="300"/>
            </conditional>
            <output_collection name="plot_out" type="list" count="1">
                <element name="labels_scatter.tabular_scatter_CLAUDIN_SUBTYPE">
                    <assert_contents>
                        <has_image_center_of_mass center_of_mass="969,732" eps="20"/>
                        <has_image_channels channels="3"/>
                        <has_image_height height="1460" delta="20"/>
                        <has_image_width width="1941" delta="20"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <!-- test 3: concordance_heatmap -->
        <test expect_num_outputs="1">
            <param name="non_commercial_use" value="True"/>
            <conditional name="plot_conditional">
                <param name="plot_type" value="concordance_heatmap"/>
                <param name="labels" value="labels.tabular"/>
                <param name="format" value="jpg"/>
                <param name="dpi" value="300"/>
            </conditional>
            <output_collection name="plot_out" type="list" count="1">
                <element name="labels.tabular_concordance_CLAUDIN_SUBTYPE">
                    <assert_contents>
                        <has_image_center_of_mass center_of_mass="1450,1306" eps="20"/>
                        <has_image_channels channels="3"/>
                        <has_image_height height="2558" delta="20"/>
                        <has_image_width width="2768" delta="20"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <!-- test 4: pr_curve -->
        <test expect_num_outputs="1">
            <param name="non_commercial_use" value="True"/>
            <conditional name="plot_conditional">
                <param name="plot_type" value="pr_curve"/>
                <param name="labels" value="labels_pr.tabular"/>
                <param name="format" value="jpg"/>
                <param name="dpi" value="300"/>
            </conditional>
            <output_collection name="plot_out" type="list" count="1">
                <element name="labels_pr.tabular_pr_curves_CLAUDIN_SUBTYPE">
                    <assert_contents>
                        <has_image_center_of_mass center_of_mass="965,733" eps="20"/>
                        <has_image_channels channels="3"/>
                        <has_image_height height="1461" delta="20"/>
                        <has_image_width width="1941" delta="20"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <!-- test 5: roc_curve -->
        <test expect_num_outputs="1">
            <param name="non_commercial_use" value="True"/>
            <conditional name="plot_conditional">
                <param name="plot_type" value="roc_curve"/>
                <param name="labels" value="labels_pr.tabular"/>
                <param name="format" value="jpg"/>
                <param name="dpi" value="300"/>
            </conditional>
            <output_collection name="plot_out" type="list" count="1">
                <element name="labels_pr.tabular_roc_curves_CLAUDIN_SUBTYPE">
                    <assert_contents>
                        <has_image_center_of_mass center_of_mass="971,732" eps="20"/>
                        <has_image_channels channels="3"/>
                        <has_image_height height="1461" delta="20"/>
                        <has_image_width width="1941" delta="20"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <!-- test 6: box_plot -->
        <test expect_num_outputs="1">
            <param name="non_commercial_use" value="True"/>
            <conditional name="plot_conditional">
                <param name="plot_type" value="box_plot"/>
                <param name="labels" value="labels_pr.tabular"/>
                <param name="format" value="jpg"/>
                <param name="dpi" value="300"/>
            </conditional>
            <output_collection name="plot_out" type="list" count="7">
                <element name="labels_pr.tabular_box_plot_CLAUDIN_SUBTYPE_Basal">
                    <assert_contents>
                        <has_image_center_of_mass center_of_mass="1485,882" eps="20"/>
                        <has_image_channels channels="3"/>
                        <has_image_height height="1766" delta="20"/>
                        <has_image_width width="2967" delta="20"/>
                    </assert_contents>
                </element>
                <element name="labels_pr.tabular_box_plot_CLAUDIN_SUBTYPE_Her2">
                    <assert_contents>
                        <has_image_center_of_mass center_of_mass="1485,882" eps="20"/>
                        <has_image_channels channels="3"/>
                        <has_image_height height="1766" delta="20"/>
                        <has_image_width width="2967" delta="20"/>
                    </assert_contents>
                </element>
                <element name="labels_pr.tabular_box_plot_CLAUDIN_SUBTYPE_LumA">
                    <assert_contents>
                        <has_image_center_of_mass center_of_mass="1485,882" eps="20"/>
                        <has_image_channels channels="3"/>
                        <has_image_height height="1766" delta="20"/>
                        <has_image_width width="2967" delta="20"/>
                    </assert_contents>
                </element>
                <element name="labels_pr.tabular_box_plot_CLAUDIN_SUBTYPE_LumB">
                    <assert_contents>
                        <has_image_center_of_mass center_of_mass="1485,882" eps="20"/>
                        <has_image_channels channels="3"/>
                        <has_image_height height="1766" delta="20"/>
                        <has_image_width width="2967" delta="20"/>
                    </assert_contents>
                </element>
                <element name="labels_pr.tabular_box_plot_CLAUDIN_SUBTYPE_NC">
                    <assert_contents>
                        <has_image_center_of_mass center_of_mass="1485,875" eps="20"/>
                        <has_image_channels channels="3"/>
                        <has_image_height height="1766" delta="20"/>
                        <has_image_width width="2967" delta="20"/>
                    </assert_contents>
                </element>
                <element name="labels_pr.tabular_box_plot_CLAUDIN_SUBTYPE_Normal">
                    <assert_contents>
                        <has_image_center_of_mass center_of_mass="1485,878" eps="20"/>
                        <has_image_channels channels="3"/>
                        <has_image_height height="1766" delta="20"/>
                        <has_image_width width="2967" delta="20"/>
                    </assert_contents>
                </element>
                <element name="labels_pr.tabular_box_plot_CLAUDIN_SUBTYPE_claudin-low">
                    <assert_contents>
                        <has_image_center_of_mass center_of_mass="1485,882" eps="20"/>
                        <has_image_channels channels="3"/>
                        <has_image_height height="1765" delta="20"/>
                        <has_image_width width="2967" delta="20"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <!-- test 7: dimred png-->
        <test expect_num_outputs="1">
            <param name="non_commercial_use" value="True"/>
            <conditional name="plot_conditional">
                <param name="plot_type" value="dimred"/>
                <param name="embeddings" value="embeddings.tabular"/>
                <param name="color" value="6"/>
                <param name="method" value="pca"/>
                <param name="labels" value="labels.tabular"/>
                <param name="format" value="png"/>
                <param name="dpi" value="300"/>
            </conditional>
            <output_collection name="plot_out" type="list" count="1">
                <element name="embeddings.tabular_pca_predicted_label">
                    <assert_contents>
                        <has_image_center_of_mass center_of_mass="970,730" eps="20"/>
                        <has_image_channels channels="4"/>
                        <has_image_height height="1461" delta="20"/>
                        <has_image_width width="1941" delta="20"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
        <!-- test 8: roc_curve svg-->
        <test expect_num_outputs="1">
            <param name="non_commercial_use" value="True"/>
            <conditional name="plot_conditional">
                <param name="plot_type" value="roc_curve"/>
                <param name="labels" value="labels_pr.tabular"/>
                <param name="format" value="svg"/>
                <param name="dpi" value="300"/>
            </conditional>
            <output_collection name="plot_out_svg" type="list" count="1">
                <element name="labels_pr.tabular_roc_curves_CLAUDIN_SUBTYPE">
                    <assert_contents>
                        <has_text_matching expression="ROC Curve"/>
                        <has_text_matching expression="True Positive Rate"/>
                    </assert_contents>
                </element>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[
@COMMON_HELP@

Flexynesis plot is a comprehensive visualization tool designed to create various types of plots for analyzing machine learning results from the Flexynesis framework. This tool supports multiple visualization types to help researchers understand their data and model performance.

Available plot types include:

- **Dimensionality Reduction:** Visualizes high-dimensional data in a lower-dimensional space using methods like PCA or UMAP.
- **Scatter Plot:** Compares known and predicted labels to assess model performance.
- **Label Concordance Heatmap:** Displays the agreement between true and predicted labels in a heatmap format.
- **Precision-Recall Curves:** Plots precision against recall to evaluate the trade-off between these metrics.
- **ROC Curves:** Visualizes the true positive rate against the false positive rate to assess model discrimination.
- **Box Plot:** Shows the distribution of predicted probabilities across different classes, highlighting medians and quartiles.


**Input Files**

Main common input file is the labels file, which is the predicted labels file generated by Flexynesis. It should contain the following columns:

- `sample_id`: Unique identifier for each sample.
- `variable`: The target variable used for the analysis.
- `class_label`: The class labels for the samples, used in box plots.
- `probability`: The predicted probabilities for the labels.
- `known_label`: The true labels for the samples, used in scatter plots and concordance heatmaps.
- `predicted_label`: The labels predicted by the Flexynesis model, used in scatter plots and concordance heatmaps.


For dimensionality reduction plots, an additional embeddings file is required, which contains the reduced-dimensional representations of the samples. This file is generated by Flexynesis.


.. class:: warningmark

PR and ROC curves can only be applied on classification tasks!


.. _Documentation: https://bimsbstatic.mdc-berlin.de/akalin/buyar/flexynesis/site/
.. _copyright holders: https://github.com/BIMSBbioinfo/flexynesis
    ]]></help>
    <expand macro="creator"/>
    <expand macro="citations"/>
</tool>